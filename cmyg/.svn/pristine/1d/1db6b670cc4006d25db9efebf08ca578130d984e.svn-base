<!DOCTYPE HTML>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0, minimum-scale=1.0, user-scalable=0, initial-scale=1.0, width=device-width" />
    <meta name="format-detection" content="telephone=no, email=no, date=no, address=no">
    <title>商品列表</title>
    <link rel="stylesheet" type="text/css" href="../../css/mui.min.css" />
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../../css/common.css" />
    <link rel="stylesheet" type="text/css" href="../../fonts/iconfont.css" />
    <style>
        .product-list {
            margin-bottom: 60px;
        }
        .foot_check{
           width: 100%;
        }
        #page-bag-frame{
           padding:bottom:0!important;
        }
        .product-list li {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            display: flex;
            display: -webkit-flex;
            align-items: center;
            position:relative;
        }

        .product-list li .product-img {
            width: 3.5rem;
            height: 3.5rem;
            background-size: 3.5rem;
            border: 1px solid #ddd;
            flex-shrink: 0;
            margin-right: 10px;
        }

        .product-list li .title {
          width: 89%;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            word-break: break-all;
        }

        .price-line {
            /*display: flex;*/
            /*display: -webkit-flex;*/
            /*justify-content: space-between;*/
            margin-top: 20px;
        }

        .mui-content {
            position: relative;
        }

        i.checkbox {
            margin-right: 5px;
            font-style: normal;
            /*height: 100%;*/
        }

        i.checkbox::before {
            content: '\e65d';
            display: block;
            color: #ccc;
            margin-right: 10px;
            font-size: 18px;
            position: relative;
            top: 50%;
            margin-top: -10px;
            width: 10px;
            vertical-align:middle;
        }

        i.checkbox.checked::before {
            content: '\e663';
            color: #E50043;
        }

        .product-list li i.checkbox {
            height: 80px;
            align-self: stretch;
        }

        .foot_check{
            display: flex;
            justify-content: space-between;
            align-items: center;
            bottom:0;
            background-color: #fff;
        }

        .foot_check div {
            margin-right: auto;
            margin-left: 20px;
        }

        .foot_check .checkbox {
            margin-left: 10px;
        }

        .foot_check .checkbox::before {
            margin-right: 0;
        }

        .foot-tj {
            height: 100%;
            line-height: 50px;
            padding: 0 15px;
            float: right!important;
        }
        .product-list.editable li i.i-del {
            display: inline-block;
        }
        .foot_show{display:none;position:fixed;bottom:0;height: 100px;width: 100%;z-index:1000;}
        .foots{display:flex;width: 100%;font-size:14px;justify-content: space-between;height: 50px;
          background-color: #fff;border-top:1px solid #f0f0f2;line-height: 50px;padding:0 10px;box-sizing:border-box;}
        .foots .item i.checkbox {vertical-align: sub;}
        .foots .item{flex:1;}
        .foots .item i{float:left;}
        .foots .item span{float:left;}
         div.lefts{float:left!important;width: 100%;}
        .delete{padding:15px;position:absolute;right:0px;top:10px;}
        .delet{background:url(../../image/654734.png) no-repeat;width: 15px;vertical-align: sub;height: 15px;background-size:15px;}
        .kong{font-size:18px;text-align: center;height: 50px;position:fixed;top:45%;width: 100%;color:red;}
        .type_hide{display:none;}
        i.foot-checkbox{}
        i.foot-checkbox::before{margin-top: 0px!important;}
        /*i.foot-checkbox{line-height: inherit;}*/
        @media (device-height:568px) and (-webkit-min-device-pixel-ratio:2){/* 兼容iphone5 */
          i.foot-checkbox::before{margin-top: -10px!important;}
          .item span{font-size: 12px;}
         }

         @media (device-height:667px) and (-webkit-min-device-pixel-ratio:2){/* 兼容iphone6 */
           i.foot-checkbox::before{margin-top: -10px!important;}
         }
         @media (device-height:736px) and (-webkit-min-device-pixel-ratio:2){/* 兼容iphone6 Plus */
            i.foot-checkbox::before{margin-top: -10px!important;}
         }
        .load-more{margin:0 0 100px 0;display:none;}
    </style>
</head>

<body style="position:relative;" class="wrap">
    <div class="page" id="page-bag-frame" style="padding-bottom:0;">
        <!-- 主页面容器 -->
        <div class="mui-inner-wrap">
            <div class="mui-content mui-scroll-wrapper">
                <ul class="product-list data-empty"></ul>
                <p class="load-more"></p>
                <div class="foot_show">
                  <div class="foots">
                     <span class="item">支付方式</span>
                     <div class="item">
                         <i id="checkeds" class="checkbox foot-checkbox iconfont"></i>
                         <!-- <i></i> -->
                         <span>购物分</span>
                     </div>
                     <div class="item">
                       <i id="checkeds" class="checkbox foot-checkbox iconfont"></i>
                       <span>消费分</span>
                     </div>
                     <div class="item">
                       <i id="checkeds" class="checkbox get-jifen foot-checkbox checked iconfont"></i>
                       <span>在线支付</span>
                     </div>
                  </div>
                  <nav class="foot_check">
                      <i class="checkbox all-checked checked iconfont" style="width:20px;height:20px;z-index:10000;"></i>
                      <label class="label all-checked">全选</label>
                      <div>
                          <p><span class="count"></span>件商品总计：<span class="amount red"></span></p>
                          <p class="type_hide">可以获得<i class="iconfont icon-jewelry"></i><span class="shop-score red"></span></p>
                      </div>
                      <span class="bg-red foot-tj">提交订单</span>
                  </nav>
                </div>
            </div>
        </div>
        <!-- <div class="kong">您的购物车暂无商品 赶紧去购物吧</div> -->

    </div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/mui.min.js"></script>
<script type="text/javascript" src="../../script/template-native.js"></script>
<script type="text/javascript" src="../../script/zepto.min.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript">
    function productList(list) {
        var _html = ''
        list.forEach(function(item) {
            _html += ('<li class="iconfont" {{data-id: id}} {{data-productid: productId}} {{data-goodsid: goodsId}} {{data-type:goodsId}}>' +
                '<div style="width:24px;"><i id="checkeds" class="checkbox checked"></i></div>' +
                '<i class="product-img"><img {{src:imgurl}} alt="" /></i>' +
                '<div class="lefts">' +
                '<h1 class="title">{$title}</h1>' +
                '<span id="delete"  class="delete"><span class="delet"></span></span>' +
                '<div class="price-line">' +
                '<div>' +
                '<i class="iconfont icon-qian red"><span class="price">{$price}</span></i>' +
                '</div>' +
                '<div>' +
                '<em>赠</em><i class="iconfont icon-jewelry"></i><span class="score">{$shopScore}</span>' +
                '</div>' +
                '<div class="numbox" id="numbox">' +
                '<span class="sp-del">-</span>' +
                '<input type="number" class="ip-amount" {{value:num}} {{data-num: num}}/>' +
                '<span class="sp-add">+</span>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '</li>').templateParse(item)
        })
        return _html
    }
    //  切换 编辑状态
    window.toggleEditable = function() {
        if ($('.product-list').toggleClass('editable').hasClass('editable')) {
            $('.product-list .checkbox.checked').removeClass('checked') // 默认不选
        } else {
            $('.product-list .checkbox').addClass('checked') // 默认都选
        }
    }
    function mes(){
       api.sendEvent({
           name: 'me',
           extra: {
               key1: 'value1',
               key2: 'value2'
           }
       });
    }
    function hide_show(){
      if($('.product-list li').length>0){
         $('.foot_show').css('display','block')
      }else{
         $('.foot_show').css('display','none')
        app.dataNull('.product-list','.product-list li','您的购物车暂无商品 赶紧去购物吧')
      }
    }
    hide_show()
    mui(".foots").on('tap','.foot-checkbox',function(){
        $(this).addClass('checked').parent().siblings().find('.foot-checkbox').removeClass('checked');
    })
    mui('.product-list').on('tap','.delete',function(){
      var $item  = $(this).parents('li')
          api.confirm({
              title: '提示',
              msg: '要删除该商品吗？',
          }, function(ret, err){
              if( ret.buttonIndex === 2 ){
                  app.ajax({
                    url : 'caritem/deleteCaritem',
                    data: {
                      'memberId': $api.getStorage('memberId'),
                      'cartitemIds[]': $item.data('id'),
                      'token':$api.getStorage('token')
                    },
                    success: function(){
                      app.toast('删除成功')
                      window.location.reload()
                      $item.remove()
                      new_active()
                      mes()
                      window.refreshAllCartItemcount($('.product-list li').length)
                      !$('.product-list li').length && app.dataNull('.product-list')
                      countAmount()
                      hide_show()
                    }
                  })
              }
          })
    })
    // 更新商品数量
    function updateOne(params){
        app.ajax({
            url : 'caritem/addCaritem',
            data: {
                memberId : $api.getStorage('memberId'),
                goodsId  : params.goodsId,
                productId: params.productId,
                num : params.num,
                token:$api.getStorage('token'),
                type: 'update',
            },
            success: function(){
              params.success && params.success()

            }
        })
    }

    // 更新数量 金额
    function countAmount(){
      var count  = 0,
          amount = 0,
          score  = 0
      $('.checkbox.checked').parents('li').each(function(){
          var $this = $(this)
          count  += Number($this.find('.ip-amount').val())
          amount += Number($this.find('.ip-amount').val()) * Number($this.find('.price').text())
          score  += Number($this.find('.ip-amount').val()) * Number($this.find('.score').text())
      })
      $('nav .count').text(count)
      $('nav .amount').text(amount)
      $('nav .shop-score').text(score)
    }
    function new_active(){
      api.execScript({
          name: 'root',
          frameName: 'bag',
          script:'inits()'
      })
    }
    apiready = function() {

       api.addEventListener({
           name: 'logins'
       }, function(ret, err){
           if( ret ){
             window.location.reload()
           }else{
                alert( JSON.stringify( err ) );
           }
       });
      //  app.ready()
        var bagData

        hide_show()
        new_active()
        var bagListAjax = app.ajaxWithLoadMore({
            url: 'caritem/queryCaritemList',
            data: {
                'memberId': $api.getStorage('memberId'),
                'token':$api.getStorage('token'),
                'pageSize':2,
                'pageNum':1
            },
            success: function(rst) {
                bagData = rst.data
                if(bagListAjax.status === 'NOMORE') return;
                if (bagListAjax.status === 'REFRESH') $('.product-list').html('') // 刷新 清空数据
                $('.product-list').append(productList(bagData))
                countAmount()
                window.refreshAllCartItemcount(bagData.length)
                api.refreshHeaderLoadDone()
                hide_show()
                var ua = navigator.userAgent.toLowerCase();
                var lens=$('.data-empty').find('li').length
                if(lens>10){
                  $('.load-more').show()
                }else{
                  $('.load-more').hide()
                }
                if (/iphone|ipad|ipod/.test(ua)) {
                  $('.foots .item i').css('line-height','74px')
                  var lens=$('.data-empty').find('li').length
                  if(lens>0,lens<3){
                    $(".product-list").css({
                        'margin-bottom':'500px!important',
                     })
                  }else if(lens>=3,lens<4){
                    $(".product-list").css({
                        'margin-bottom':'400px!important',
                     })
                  }else if(lens>=4,lens<5){
                    $(".product-list").css({
                        'margin-bottom':'200px!important',
                     })
                  }else if(lens>=5){
                    $(".product-list").css({
                        'margin-bottom':'130px!important',
                     })
                  }
                } else if (/android/.test(ua)) {
                }
            }
        })

        // 下拉刷新
        api.setRefreshHeaderInfo({
                bgColor: '#fff',
                textColor: '#333',
                textDown: '下拉刷新...',
                textUp: '松开刷新...'

            }, function(ret, err) {
                //在这里从服务器加载数据，加载完成后调用api.refreshHeaderLoadDone()方法恢复组件到默认状态
                bagListAjax.init()()
                // window.location.reload()
                hide_show()
                new_active()
            })

        // 底部加载更多
        api.addEventListener({
            name: 'scrolltobottom'
        }, function(ret, err) {
            app.throttle(bagListAjax);
        })

        bagListAjax.init()()
    }


    // 全选
    mui('nav').on('tap', '.all-checked', function(){
        $('.checkbox.all-checked').toggleClass('checked').hasClass('checked')
        ? $('.product-list li .checkbox').addClass('checked')
        : $('.product-list li .checkbox').removeClass('checked')

        countAmount()
    })
    mui('.product-list').on('tap', 'i.checkbox', function() {
        $(this).toggleClass('checked')
        // 全部勾上之后
        var Leng=$('.product-list li .checked').length
        var allLeng=$('.product-list li .checkbox').length
        if(Leng==allLeng){
            $('.checkbox.all-checked').addClass('checked')
        }else{
           $('.checkbox.all-checked').removeClass('checked')
        }
        countAmount()
    })
    // 数量 -
    mui('.product-list').on('tap', '.sp-del', function(){
      var $item  = $(this).parents('li'),
          $input = $(this).siblings('input')
      if($input.val() ==  1) {
          api.confirm({
              title: '提示',
              msg: '要删除该商品吗？',
          }, function(ret, err){
              if( ret.buttonIndex === 2 ){
                  app.ajax({
                    url : 'caritem/deleteCaritem',
                    data: {
                      'memberId': $api.getStorage('memberId'),
                      'cartitemIds[]': $item.data('id'),
                      'token':$api.getStorage('token')
                    },
                    success: function(){
                      app.toast('删除成功')
                      // window.location.reload()
                      $item.remove()
                      new_active()
                      window.refreshAllCartItemcount($('.product-list li').length)
                      !$('.product-list li').length && app.dataNull('.product-list')
                      countAmount()
                      hide_show()
                    }
                  })
              }
          })
      } else {
        updateOne({
          productId: $item.data('productid'),
          goodsId  : $item.data('goodsid'),
          num: Number($input.val()) - 1,
          success: function(){
            $input.val(Number($input.val()) - 1)
            countAmount()
          }
        })
      }
    })
    // 数量 +
    mui('.product-list').on('tap', '.sp-add', function(){
      var $input = $(this).siblings('input'),
          $item  = $(this).parents('li')
      updateOne({
        productId: $item.data('productid'),
        goodsId  : $item.data('goodsid'),
        num: Number($input.val()) + 1,
        success: function(){
          $input.val(Number($input.val()) + 1)
          countAmount()
        }
      })
    })
    // 数量 input
    mui('.product-list').on('input', 'input.ip-amount', function(){
      $(this).val($(this).val().replace(/[^0-9]/g, ''))
    })
    mui('.product-list').on('change', 'input.ip-amount', function(){
      var $input = $(this)
      if(!$input.val().trim() || $input.val().trim() == 0) {
        api.confirm({
            title: '提示',
            msg: '要删除该商品吗？',
        }, function(ret, err){
            if( ret.buttonIndex === 2 ){
                $input.parents('li').remove()
                !$('.product-list li').length && app.dataNull('.product-list')
                $input.data('num', $input.val())
                mes()
            } else {
                $input.val($input.data('num'))
            }
        })
      }
    })
    // 编辑购物车
    mui('header').on('tap', '#edit-or-finished', function() {
        $('.product-list').toggleClass('editable') // 切换是否可编辑
            // 编辑模式下
        if ($('.product-list').hasClass('editable')) {
            $('#edit-or-finished').text('完成')
        }
        // 购买模式下
        else {
            $('#edit-or-finished').text('编辑')
        }
    })
   //判断点击checkbox
      var items=$(".foots").children('.item')
       for(var i=0;i<items.length;i++){
         if($(items[1]).children('.foot-checkbox').hasClass('checked')){
              $('.foots').siblings('.foot_check').find('.type_hide').css('display','none')
         }
         if($(items[2]).children('.foot-checkbox').hasClass('checked')){
              $('.foots').siblings('.foot_check').find('.type_hide').css('display','none')
         }
         if($(items[3]).children('.foot-checkbox').hasClass('checked')){
             $('.foots').siblings('.foot_check').find('.type_hide').css('display','block')
         }
         $(items[i]).children('.foot-checkbox').on('tap',function(){
            if($(this).hasClass('get-jifen')){
              $('.foots').siblings('.foot_check').find('.type_hide').css('display','block')
            }else{
              $('.foots').siblings('.foot_check').find('.type_hide').css('display','none')
            }
         })
       }
  //提交订单
  $('.foot_check').on('tap','.foot-tj',function(){
       var cats=[],ids=$(this).parents('.foot_show').siblings('.data-empty').find('li.iconfont')
       for(var i=0; i<ids.length;i++){
        var hasClass=$(ids[i]).find('#checkeds').hasClass("checked")
         if(hasClass){
           var cartId=$(ids[i]).attr("data-id")
              cats.push(cartId)
         }else if(!hasClass){
              // alert(123)
         }
       }
        var prePayType=[]
        for(var i=0;i<items.length;i++){
             if($(items[1]).children('.foot-checkbox').hasClass('checked')){
                 prePayType=3
             }
             if($(items[2]).children('.foot-checkbox').hasClass('checked')){
                 prePayType=2
             }
             if($(items[3]).children('.foot-checkbox').hasClass('checked')){
                 prePayType=1
             }
        }
        var prePayTypes=prePayType
        var totalPrice=$(".amount").html()
        if(cats==''){
          app.toast('请选择产品再提交')
        }else{
          app.ajax({
            url:'ordergoods/addOrdergoods',
            data:{
              'token':$api.getStorage('token'),
              'memberId':$api.getStorage('memberId'),
              'prePayType':prePayTypes,
              'totalPrice':totalPrice,
              'cartIds[]':cats.join(',')
            },
            success:function(data){
              if(data.code==0){
                new_active()
                mes()
                window.location.reload()
                api.execScript({
                  name: 'root',
                  frameName: 'bag',
                  script: 'reloadFrames(1)'
                })
              }else{
                alert(data.msg)
              }
            }
          })
        }
  })
  app.details('.product-list li','data-goodsid','data-productid','checkeds','delete','numbox')

</script>
</html>
